<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Notas Online</title>
    <link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#3498db">
<meta name="apple-mobile-web-app-capable" content="yes">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(52, 152, 219, 0.95);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            z-index: 9999;
        }

        .app-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .app-logo {
            max-width: 300px; 
            height: auto;
            margin-bottom: 10px;
            border-radius: 5px;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 28px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 15px;
            background: #ecf0f1;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            transition: background 0.3s;
            font-weight: bold;
            color: #2c3e50;
        }
        
        .tab.active {
            background: #3498db;
            color: white;
        }

        .tab.sent-tab {
            background-color: #d1e7dd; 
            color: #0f5132;
        }

        .tab.sent-tab.active {
            background-color: #27ae60; 
            color: white;
        }
        
        .category-filters {
            display: flex;
            flex-wrap: wrap; 
            gap: 8px;
            margin-bottom: 25px;
            padding: 10px 0;
        }

        .filter-btn {
            padding: 8px 15px;
            background: #f1c40f; 
            color: #2c3e50;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }

        .filter-btn.active {
            background: #e67e22; 
            color: white;
            font-weight: bold;
        }

        .search-input {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid #3498db;
            border-radius: 8px;
            margin-bottom: 25px;
            outline: none;
        }
        
        .new-order-btn {
            width: 100%;
            padding: 20px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 30px;
            transition: background 0.3s;
        }
        
        .header-section {
            background: #ecf0f1;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 18px;
            color: #2c3e50;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
        }
        
        .date-display {
            font-size: 18px;
            color: #7f8c8d;
            padding: 12px;
            background: white;
            border-radius: 5px;
        }
        
        .category {
            margin-bottom: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .category-title {
            background: #3498db;
            color: white;
            padding: 15px;
            font-size: 20px;
            font-weight: bold;
        }
        
        .product-row {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #ecf0f1;
            background: white;
        }
        
        .product-name {
            flex: 1;
            font-size: 16px;
            color: #2c3e50;
            padding-right: 10px;
        }
        
        .quantity-input {
            width: 70px; 
            padding: 8px;
            font-size: 16px;
            text-align: center;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            height: 40px; 
        }

        .quantity-input:focus {
            border-color: #3498db;
            outline: none;
        }
        
        .summary-section {
            background: #e8f5e9;
            padding: 25px;
            border-radius: 8px;
            margin-top: 40px;
        }

        .summary-title {
            font-size: 20px;
            font-weight: bold;
            color: #27ae60;
            margin-bottom: 15px;
        }
        
        .summary-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 16px;
            line-height: 1.8;
            white-space: pre-wrap;
            min-height: 100px;
            border: 2px solid #27ae60;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap; 
        }

        .copy-btn, .sent-btn, { 
            padding: 15px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
            flex: 1 1 30%; 
        }
        
        .copy-btn {
            background: #3498db;
            color: white;
        }

        .sent-btn {
            background: #27ae60;
            color: white;
        }
    
        .sent-btn.marked {
            background: #7f8c8d; 
        }
        
        .delete-btn {
            padding: 8px 15px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: #27ae60;
            color: white;
            padding: 15px 25px;
            border-radius: 5px;
            font-size: 16px;
            display: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 10000;
        }
        
        .toast.show {
            display: block;
        }

        .toast.error {
            background: #e74c3c;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px; 
            }
            .container {
                padding: 15px; 
                margin: 0; 
            }
            h1 {
                font-size: 24px;
            }
            .app-logo {
                max-width: 200px; 
            }
            .search-input, input[type="text"], .date-display {
                font-size: 16px;
                padding: 10px;
            }
            .product-row {
                padding: 10px;
            }
            .product-name {
                font-size: 14px;
            }
            .quantity-input {
                width: 60px; 
                font-size: 14px;
                padding: 5px;
                height: 35px;
            }
            .action-buttons {
                flex-direction: column; 
            }
            .copy-btn, .sent-btn, .pdf-btn, .new-order-btn {
                font-size: 16px;
                padding: 12px;
                flex: 1 1 100%; 
            }
            .summary-content {
                font-size: 14px;
                padding: 15px;
            }
            .category-filters {
                gap: 5px;
            }
            .filter-btn {
                font-size: 12px;
                padding: 6px 10px;
            }
        }

        .category.hidden, .product-row.hidden {
            display: none;
        }

        .order-content {
            display: none;
        }

        .order-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">Cargando catálogo...</div>
    
    <div class="container" style="display:none;" id="mainContent">
        <div class="app-header">
            <img src="logo.jpg" 
                 alt="Logo de la empresa" 
                 class="app-logo"
                 onerror="this.style.display='none'">
            <h1>NOTAS ONLINE</h1>
        </div>

        <button class="new-order-btn" onclick="createNewOrder()">
            + NUEVA NOTA
        </button>
        
        <div class="tabs" id="tabsContainer"></div>
        
        <div id="ordersContainer"></div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        let orders = [];
        let activeOrderId = null;
        let catalog = {};
        let activeCategoryFilter = 'ALL'; 
        
        // CONFIGURACIÓN
        const STORAGE_KEY = 'orderSystemNotes';
        const CATALOG_CACHE_KEY = 'catalogCache';
        const CSV_URL = './PRODUCTOS.csv'; // Archivo local
        
        // ======================================================================
        // CARGA DEL CATÁLOGO CON VALIDACIÓN Y CACHÉ
        // ======================================================================
        
        async function loadCatalogFromCSV() {
            const loadingEl = document.getElementById('loadingOverlay');
            loadingEl.textContent = 'Cargando catálogo...';
            
            try {
                // Intentar cargar desde caché primero
                const cachedCatalog = localStorage.getItem(CATALOG_CACHE_KEY);
                if (cachedCatalog) {
                    catalog = JSON.parse(cachedCatalog);
                    console.log('Catálogo cargado desde caché');
                }
                
                // Intentar actualizar desde CSV
                const response = await fetch(CSV_URL);
                
                if (!response.ok) {
                    throw new Error(`Error al cargar CSV: ${response.status}`);
                }
                
                const csvText = await response.text();
                
                if (!csvText || csvText.trim().length < 10) {
                    throw new Error('CSV vacío o inválido');
                }
                
                const newCatalog = parseCSV(csvText);
                
                if (Object.keys(newCatalog).length === 0) {
                    throw new Error('No se encontraron productos en el CSV');
                }
                
                catalog = newCatalog;
                localStorage.setItem(CATALOG_CACHE_KEY, JSON.stringify(catalog));
                console.log(`Catálogo actualizado: ${Object.keys(catalog).length} categorías`);
                
            } catch (error) {
                console.error('Error cargando catálogo:', error);
                
                // Si hay caché, usar ese
                if (Object.keys(catalog).length > 0) {
                    showToast('Usando catálogo guardado (sin conexión)', 'error');
                } else {
                    loadingEl.style.backgroundColor = '#e74c3c';
                    loadingEl.innerHTML = `
                        Error al cargar el catálogo.<br>
                        ${error.message}<br><br>
                        Verifica que PRODUCTOS.csv esté en la carpeta correcta.
                    `;
                    return;
                }
            }
            
            // Inicializar aplicación
            loadOrders();
            
            if (orders.length === 0) {
                createNewOrder(false);
            } else {
                renderTabs();
                renderOrders();
            }
            
            loadingEl.style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }
        
        function parseCSV(csv) {
            const newCatalog = {};
            const lines = csv.split(/\r?\n/);
            
            // Saltar header
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // Manejar comillas en CSV
                const parts = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/)
                    .map(p => p.trim().replace(/^"|"$/g, ''));
                
                if (parts.length >= 2) {
                    const category = parts[0] ? parts[0].toUpperCase() : 'SIN CATEGORÍA'; 
                    const product = parts[1];
                
                    if (product) {
                        if (!newCatalog[category]) {
                            newCatalog[category] = [];
                        }
                        newCatalog[category].push(product);
                    }
                }
            }
            
            return newCatalog;
        }

        // ======================================================================
        // PERSISTENCIA CON BACKUP AUTOMÁTICO
        // ======================================================================
        
        function saveOrders() {
            try {
                const data = JSON.stringify(orders);
                localStorage.setItem(STORAGE_KEY, data);
                localStorage.setItem('activeOrderId', activeOrderId);
                
                // Backup adicional con timestamp
                const backupKey = `${STORAGE_KEY}_backup_${Date.now()}`;
                localStorage.setItem(backupKey, data);
                
                // Limpiar backups antiguos (mantener solo los últimos 3)
                cleanOldBackups();
                
            } catch (e) {
                console.error("Error guardando:", e);
                showToast('Error al guardar. Espacio lleno.', 'error');
            }
        }
        
        function cleanOldBackups() {
            const backups = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(`${STORAGE_KEY}_backup_`)) {
                    backups.push(key);
                }
            }
            
            if (backups.length > 3) {
                backups.sort().slice(0, -3).forEach(key => {
                    localStorage.removeItem(key);
                });
            }
        }

        function loadOrders() {
            try {
                const savedOrders = localStorage.getItem(STORAGE_KEY);
                const savedActiveId = localStorage.getItem('activeOrderId');

                if (savedOrders) {
                    orders = JSON.parse(savedOrders);
                    orders.forEach(o => {
                        if (typeof o.isSent === 'undefined') {
                            o.isSent = false;
                        }
                    });

                    if (savedActiveId) {
                        activeOrderId = orders.find(o => o.id == savedActiveId) 
                            ? parseInt(savedActiveId) 
                            : orders[0].id;
                    } else if (orders.length > 0) {
                        activeOrderId = orders[0].id;
                    }
                }
            } catch (e) {
                console.error("Error cargando:", e);
                orders = [];
            }
        }
        
        // ======================================================================
        // GESTIÓN DE NOTAS
        // ======================================================================
        
        function getCurrentDate() {
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = now.getFullYear();
            return `${day}/${month}/${year}`;
        }
        
        function createNewOrder(showToastMessage = true) {
            if (Object.keys(catalog).length === 0) {
                showToast('Catálogo no disponible', 'error');
                return;
            }

            const noteName = prompt('Nome da nova Nota');
            const defaultName = `Nota ${orders.length + 1}`;
            
            const orderId = Date.now();
            const order = {
                id: orderId,
                name: noteName && noteName.trim() ? noteName.trim() : defaultName,
                date: getCurrentDate(),
                client: '',
                place: '',
                products: {},
                isSent: false
            };
            
            orders.push(order);
            activeOrderId = orderId;
            activeCategoryFilter = 'ALL';
            renderTabs();
            renderOrders();
            saveOrders();
            if (showToastMessage) showToast(`Nueva nota '${order.name}' creada`);
        }

        function markAsSent(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                const newState = !order.isSent;
                order.isSent = newState;
                saveOrders();
                renderTabs();
                const sentBtn = document.querySelector(`#order-${orderId} .sent-btn`);
                if (sentBtn) {
                    sentBtn.textContent = newState ? 'DESMARCAR COMO ENVIADA' : 'MARCAR COMO ENVIADA';
                    sentBtn.classList.toggle('marked', newState);
                }
                showToast(`Nota ${newState ? 'marcada como enviada' : 'desmarcada'}`);
            }
        }

        function deleteOrder(orderId) {
            if (orders.length === 1) {
                showToast('Debe mantener al menos una nota', 'error');
                return;
            }
            
            if (confirm('¿Eliminar esta nota?')) {
                orders = orders.filter(o => o.id !== orderId);
                if (activeOrderId === orderId) {
                    activeOrderId = orders[0].id;
                }
                renderTabs();
                renderOrders();
                saveOrders();
                showToast('Nota eliminada');
            }
        }
        
        function switchOrder(orderId) {
            activeOrderId = orderId;
            activeCategoryFilter = 'ALL';
            renderTabs();
            renderOrders();
        }
        
        // ======================================================================
        // RENDERIZADO
        // ======================================================================
        
        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = orders.map(order => `
                <button class="tab ${order.id === activeOrderId ? 'active' : ''} ${order.isSent ? 'sent-tab' : ''}" 
                        onclick="switchOrder(${order.id})">
                    ${order.name}
                    ${orders.length > 1 ? `<span class="delete-btn" onclick="event.stopPropagation(); deleteOrder(${order.id})">✕</span>` : ''}
                </button>
            `).join('');
        }
        
        function renderOrders() {
            const container = document.getElementById('ordersContainer');
            container.innerHTML = orders.map(order => `
                <div class="order-content ${order.id === activeOrderId ? 'active' : ''}" id="order-${order.id}">
                    ${renderOrderForm(order)}
                </div>
            `).join('');

            if (activeOrderId) {
                renderCategoryFilters(activeOrderId);
                const searchInput = document.getElementById(`search-${activeOrderId}`);
                if (searchInput) {
                    filterProducts(searchInput.value);
                } else {
                    filterProducts('');
                }
            }
        }

        function renderCategoryFilters(orderId) {
            const container = document.getElementById(`category-filters-${orderId}`);
            if (!container) return;

            const categories = Object.keys(catalog).sort();

            let html = `<button class="filter-btn ${activeCategoryFilter === 'ALL' ? 'active' : ''}" 
                        onclick="setCategoryFilter('ALL')">TODAS</button>`;
            
            categories.forEach(category => {
                const isActive = activeCategoryFilter === category;
                html += `<button class="filter-btn ${isActive ? 'active' : ''}" 
                            onclick="setCategoryFilter('${category.replace(/'/g, "\\'")}')">${category}</button>`;
            });

            container.innerHTML = html;
        }

        function renderOrderForm(order) {
            if (Object.keys(catalog).length === 0) {
                return '<p style="text-align: center; color: red;">Catálogo no disponible</p>';
            }

            const sentButtonText = order.isSent ? 'DESMARCAR COMO ENVIADA' : 'MARCAR COMO ENVIADA';
            const sentButtonClass = order.isSent ? 'sent-btn marked' : 'sent-btn';

            return `
                <div class="header-section">
                    <div class="form-group">
                        <label>CLIENTE:</label>
                        <input type="text" id="client-${order.id}" value="${order.client}" 
                               onchange="updateOrder(${order.id}, 'client', this.value)"
                               placeholder="Nombre del cliente">
                    </div>
                    <div class="form-group">
                        <label>LUGAR:</label>
                        <input type="text" id="place-${order.id}" value="${order.place}"
                               onchange="updateOrder(${order.id}, 'place', this.value)"
                               placeholder="Localidad o dirección">
                    </div>
                    <div class="form-group">
                        <label>FECHA:</label>
                        <div class="date-display">${order.date}</div>
                    </div>
                </div>

                <input type="text" 
                       id="search-${order.id}"
                       class="search-input"
                       placeholder="Buscar producto..."
                       oninput="filterProducts(this.value)">

                <div class="category-filters" id="category-filters-${order.id}">
                </div>
                
                <div id="product-list-${order.id}">
                    ${Object.keys(catalog).map(category => `
                        <div class="category" data-category="${category.toUpperCase()}" id="category-${order.id}-${category.replace(/\s/g, '-')}">
                            <div class="category-title">${category}</div>
                            ${(catalog[category] || []).map(product => {
                                const qty = order.products[product] || ''; 
                                const escapedProduct = product.replace(/'/g, "\\'"); 
                                
                                return `
                                <div class="product-row" data-product="${product.toLowerCase()}">
                                    <div class="product-name">${product}</div>
                                    <input type="number" 
                                           class="quantity-input" 
                                           min="0" 
                                           value="${qty}"
                                           onchange="updateProduct(${order.id}, '${escapedProduct}', this.value)"
                                           placeholder="0">
                                </div>
                                `;
                            }).join('')}
                        </div>
                    `).join('')}
                </div>
                
                <div class="summary-section">
                    <div class="summary-title">RESUMEN DE LA NOTA</div>
                    <div class="summary-content" id="summary-${order.id}">${generateSummary(order)}</div>
                    <div class="action-buttons">
                        <button class="copy-btn" onclick="copySummary(${order.id})">
                            COPIAR NOTA
                        </button>
                        <button class="${sentButtonClass}" onclick="markAsSent(${order.id})">
                            ${sentButtonText}
                        </button>
                    </div>
                </div>
            `;
        }
        
        function updateOrder(orderId, field, value) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                order[field] = value;
                updateSummary(orderId);
                saveOrders();
            }
        }
        
        function updateProduct(orderId, product, quantity) {
            const order = orders.find(o => o.id === orderId);
            if (order) {
                const numQty = parseInt(quantity); 
                if (numQty > 0) {
                    order.products[product] = numQty;
                } else {
                    delete order.products[product];
                }
                updateSummary(orderId);
                saveOrders();
            }
        }

        // ======================================================================
        // FILTROS
        // ======================================================================

        function setCategoryFilter(category) {
            activeCategoryFilter = category;
            renderCategoryFilters(activeOrderId); 
            filterProducts(document.getElementById(`search-${activeOrderId}`).value);
        }

        function filterProducts(searchTerm) {
            const orderId = activeOrderId;
            if (!orderId) return;

            const term = searchTerm.toLowerCase().trim();
            const orderContainer = document.getElementById(`order-${orderId}`);
            if (!orderContainer) return;

            const categoryElements = orderContainer.querySelectorAll('.category');
            let anyCategoryVisible = false;

            categoryElements.forEach(categoryEl => {
                const categoryName = categoryEl.querySelector('.category-title').textContent.toUpperCase();
                const productRows = categoryEl.querySelectorAll('.product-row');
                
                let categoryHasVisibleProducts = false;
                
                productRows.forEach(rowEl => {
                    const productName = rowEl.querySelector('.product-name').textContent.toLowerCase();
                    
                    const matchesSearch = !term || productName.includes(term);
                    const matchesCategoryFilter = activeCategoryFilter === 'ALL' || activeCategoryFilter === categoryName;

                    if (matchesSearch && matchesCategoryFilter) {
                        rowEl.classList.remove('hidden');
                        categoryHasVisibleProducts = true;
                    } else {
                        rowEl.classList.add('hidden');
                    }
                });

                if (categoryHasVisibleProducts) {
                    categoryEl.classList.remove('hidden');
                    anyCategoryVisible = true;
                } else {
                    categoryEl.classList.add('hidden');
                }
            });

            const noResults = document.getElementById(`no-results-${orderId}`);
            if (!anyCategoryVisible) {
                if (!noResults) {
                    const msg = document.createElement('p');
                    msg.id = `no-results-${orderId}`;
                    msg.style.textAlign = 'center';
                    msg.style.color = '#e74c3c';
                    msg.textContent = 'No se encontraron productos.';
                    orderContainer.querySelector('.header-section').after(msg);
                }
            } else if (noResults) {
                noResults.remove();
            }
        }

        // ======================================================================
        // RESUMEN Y ACCIONES
        // ======================================================================

       function generateSummary(order) {
            let summary = `NOTA\n`; 
            summary += `═══════════════\n\n`; // Línea más corta
            summary += `Cliente: ${order.client || '(sin especificar)'}\n`;
            summary += `Lugar: ${order.place || '(sin especificar)'}\n`;
            summary += `Fecha: ${order.date}\n\n`;
            
            const productsList = Object.entries(order.products);
            
            if (productsList.length === 0) {
                summary += `(No hay productos agregados)\n`;
            } else {
                summary += `PRODUCTOS:\n`;
                summary += `═══════════════\n`; // Línea más corta
                
                Object.keys(catalog).forEach(category => {
                    const categoryProducts = productsList.filter(([product]) => 
                        (catalog[category] || []).includes(product)
                    );
                    
                    if (categoryProducts.length > 0) {
                        summary += `\n${category}:\n`;
                        categoryProducts.forEach(([product, qty]) => {
                            summary += `  • ${product} ---- ${qty}\n`;
                            // Aquí eliminamos la suma de totalUnits
                        });
                    }
                });
                
                summary += `\n═══════════════\n`; // Línea final más corta
                // Aquí eliminamos la línea que mostraba el Total Unidades
            }
            
            return summary;
        }
        
        function updateSummary(orderId) {
            const order = orders.find(o => o.id === orderId);
            const summaryEl = document.getElementById(`summary-${orderId}`);
            if (order && summaryEl) {
                summaryEl.textContent = generateSummary(order);
            }
        }
        
        function copySummary(orderId) {
            const summaryEl = document.getElementById(`summary-${orderId}`);
            const text = summaryEl.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('Nota copiada para WhatsApp'); 
            }).catch(() => {
                showToast('Error al copiar', 'error');
            });
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show';
            if (type === 'error') toast.classList.add('error');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // ======================================================================
        // GENERAR PDF
        // ======================================================================
            const originalElement = document.getElementById(`order-${orderId}`);
            const element = originalElement.cloneNode(true);
            
            // Limpiar para PDF
            const actionButtons = element.querySelector('.action-buttons');
            if (actionButtons) actionButtons.remove();
            const searchInput = element.querySelector('.search-input');
            if (searchInput) searchInput.remove();
            const categoryFilters = element.querySelector('.category-filters');
            if (categoryFilters) categoryFilters.remove();
            
            element.querySelectorAll('.product-row').forEach(row => {
                const input = row.querySelector('.quantity-input');
                const qty = input ? parseInt(input.value) : 0;
                
                if (qty > 0) {
                    const display = document.createElement('div');
                    display.textContent = qty;
                    display.style.width = '70px';
                    display.style.textAlign = 'center';
                    display.style.fontWeight = 'bold';
                    display.style.color = '#e74c3c'; 
                    input.parentNode.replaceChild(display, input);
                } else {
                    row.remove();
                }
            });

            const opt = {
                margin: 1, 
                filename: `Nota_${order.name.replace(/\s/g, '_')}_${order.date.replace(/\//g, '-')}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2, logging: false, dpi: 192, letterRendering: true, useCORS: true },
                jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' } 
            };

            document.body.appendChild(element); 
            html2pdf().from(element).set(opt).save().then(() => {
                element.remove(); 
                showToast('PDF generado');
            }).catch(error => {
                element.remove(); 
                showToast('Error al generar PDF', 'error');
                console.error('Error PDF:', error);
            });
        }
    
        // ======================================================================
        // INICIO
        // ======================================================================
        document.addEventListener('DOMContentLoaded', loadCatalogFromCSV);

    </script>
</body>
</html>
